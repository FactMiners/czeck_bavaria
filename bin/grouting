#!/usr/bin/env python

##############################################################################
#                                                                            #
#  Grouting: A Document Image Groundtruthing Web Service                     #
#                                                                            #
#  Copyright (c) 2018 by Anguelos Nicolaou <anguelos.nicolaou@gmail.com>     #
#                                                                            #
#  Grouting is free software: you can redistribute it and/or modify it       #
#  under the terms of the GNU General Public License as published by the     #
#  Free Software Foundation, either version 3 of the License, or (at your    #
#  option) any later version.                                                #
#                                                                            #
#  Grouting is distributed in the hope that it will be useful, but           #
#  WITHOUT ANY WARRANTY; without even the implied warranty of                #
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU         #
#  General Public License for more details.                                  #
#                                                                            #
#  You should have received a copy of the GNU General Public License         #
#  along with Foobar.  If not, see <http://www.gnu.org/licenses/>.           #
#                                                                            #
#  @license GPL-3.0+ <http://spdx.org/licenses/GPL-3.0+>                     #
#                                                                            #
##############################################################################


import json
import random
import string
import cherrypy #also routes are needed
import sys
import glob
import cv2
import os
import hashlib
import jinja2
import tqdm

# Template parameters
# id: md5sum
# previous_id: md5sum
# next_id: md5sum

client_jinja_template="""<!doctype html>
<html>
<head>
<meta charset="UTF-8" />
<title>Canvas Layers Test</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        var user_name="N/A";
        var rectangles_ltrb = [];
        var captions = [];
        var deleted_rectangles_ltrb = [];
        var deleted_captions = [];
        var active_box=-1;
        
        function set_colors(element,value){
            if(element === undefined && value === undefined){
                document.getElementById("w_prefix_color_empty").innerHTML="#FF0000";
                document.getElementById("w_prefix_color_full").innerHTML="#00FF00";
                document.getElementById("l_prefix_color_empty").innerHTML="#FF00FF";
                document.getElementById("l_prefix_color_full").innerHTML="#00FF00";
                document.getElementById("g_prefix_color_empty").innerHTML="#0000FF";
                document.getElementById("g_prefix_color_full").innerHTML="#0000FF";
                document.getElementById("other_prefix_color_empty").innerHTML="#0000FF";
                document.getElementById("other_prefix_color_full").innerHTML="#0000FF";
                document.getElementById("transcription_font_color").innerHTML="#888888";
                document.getElementById("transcription_font_type").innerHTML="Calibri";
                document.getElementById("transcription_font_size").innerHTML="18pt";
            }else if(element.constructor === String && value === undefined){
                var reply=window.prompt(element.split("_").join(" "),document.getElementById(element).innerHTML.trim());
                if(element=="transcription_font_type"){
                    if(reply.length>0){
                        document.getElementById(element).innerHTML=reply;
                    }else{
                        alert("Font must be a non-empty striong");
                    }
                }else if(element=="transcription_font_size"){
                    if(reply.match(/^[0-9a-f][0-9a-f]pt/i)){
                        document.getElementById(element).innerHTML=reply;
                    }else{
                        alert("Expecting font size of the format 18pt got "+reply);
                    }                
                }else{
                    if(reply.match(/^#[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]/i)){
                        document.getElementById(element).innerHTML=reply;
                    }else{
                        alert("Expecting Color of the format #AA00FF got "+reply);
                    }
                }
            }else if(w_prefix_color_empty in element && w_prefix_color_full in element && l_prefix_color_empty in element ){ //TODO (anguelos) improve the check;
                document.getElementById("w_prefix_color_empty").innerHTML=element["w_prefix_color_empty"];
                document.getElementById("w_prefix_color_full").innerHTML=element["w_prefix_color_full"];
                document.getElementById("l_prefix_color_empty").innerHTML=element["l_prefix_color_empty"];
                document.getElementById("l_prefix_color_full").innerHTML=element["l_prefix_color_full"];
                document.getElementById("g_prefix_color_empty").innerHTML=element["g_prefix_color_empty"];
                document.getElementById("g_prefix_color_full").innerHTML=element["g_prefix_color_full"];
                document.getElementById("other_prefix_color_empty").innerHTML=element["other_prefix_color_empty"];
                document.getElementById("other_prefix_color_full").innerHTML=element["other_prefix_color_full"];
                document.getElementById("transcription_font_color").innerHTML=element["transcription_font_color"];
                document.getElementById("transcription_font_type").innerHTML=element["transcription_font_type"];
                document.getElementById("transcription_font_size").innerHTML=element["transcription_font_size"];
            }else {
                document.getElementById(element).innerHTML=value;
            }
        }
        function get_colors(){
            var element={};
            element["w_prefix_color_empty"]=document.getElementById("w_prefix_color_empty").innerHTML;
            element["w_prefix_color_full"]=document.getElementById("w_prefix_color_full").innerHTML;
            element["l_prefix_color_empty"]=document.getElementById("l_prefix_color_empty").innerHTML;
            element["l_prefix_color_full"]=document.getElementById("l_prefix_color_full").innerHTML;
            element["g_prefix_color_empty"]=document.getElementById("g_prefix_color_empty").innerHTML;
            element["g_prefix_color_full"]=document.getElementById("g_prefix_color_full").innerHTML;
            element["other_prefix_color_empty"]=document.getElementById("other_prefix_color_empty").innerHTML;
            element["other_prefix_color_full"]=document.getElementById("other_prefix_color_full").innerHTML;
            element["transcription_font_color"]=document.getElementById("transcription_font_color").innerHTML;
            element["transcription_font_type"]=document.getElementById("transcription_font_type").innerHTML;
            element["transcription_font_size"]=document.getElementById("transcription_font_size").innerHTML;
            return element;                
        }
        
        function update_new_caption_prefix(prefix_str){
            var btn_textblock=document.getElementById("btn_textblock");
            var btn_textline=document.getElementById("btn_textline");
            var btn_word=document.getElementById("btn_word");
            var btn_graphic=document.getElementById("btn_graphic");
            var btn_custom=document.getElementById("btn_custom");
            btn_textblock.style.color = "";
            btn_textline.style.color = "";
            btn_word.style.color = "";
            btn_graphic.style.color = "";
            btn_custom.style.color = "";
            if(prefix_str==="B"){
                document.getElementById("new_caption_prefix").innerHTML=prefix_str;
                btn_textblock.style.color = "#AAAAAA";
            }else if(prefix_str==="L"){
                document.getElementById("new_caption_prefix").innerHTML=prefix_str;
                btn_textline.style.color = "#AAAAAA";
            }else if(prefix_str==="W"){
                document.getElementById("new_caption_prefix").innerHTML=prefix_str;
                btn_word.style.color = "#AAAAAA";
            }else if(prefix_str==="G"){
                document.getElementById("new_caption_prefix").innerHTML=prefix_str;
                btn_graphic.style.color = "#AAAAAA";
            }else if(prefix_str===""){
                var previous_value=document.getElementById("new_caption_prefix").innerHTML;
                alert("previous caption "+previous_value);
                document.getElementById("new_caption_prefix").innerHTML=window.prompt("Custom Prefix: ",previous_value);
                btn_custom.style.color = "#AAAAAA";
            }else{
                document.getElementById("new_caption_prefix").innerHTML=prefix_str;
                btn_custom.style.color = "#AAAAAA";
            }
        }
    
        function read_keys_actions(){
            var key_actions=new Map([]);
            var table = document.getElementById("keys_table");
            for (var i = 1, row; row = table.rows[i]; i++) {
                var key=table.rows[i].cells[0].innerHTML.trim();
                var val=parseInt(table.rows[i].cells[1].innerHTML);
                key_actions[key]=val;
            }
            return key_actions;
        }

        function update_keys_actions(m){        
            var table = document.getElementById("keys_table");
            table.innerHTML = "";
            var hrow = table.insertRow();
            var th1=document.createElement("th");th1.innerHTML="Action";
            var th2=document.createElement("th");th2.innerHTML="ASCII Code";
            var th3=document.createElement("th");th3.innerHTML="String";
            hrow.appendChild(th1);hrow.appendChild(th2);hrow.appendChild(th3);
            for(var key in m){
                (function(){
                var row=table.insertRow();
                var cell_caption=row.insertCell();
                var cell_code=row.insertCell();
                var cell_string=row.insertCell();
                var cell_button=row.insertCell();
                cell_caption.innerHTML=key;
                cell_code.innerHTML=m[key]+"";
                cell_string.innerHTML=String.fromCharCode(m[key]);
                var btn = document.createElement("BUTTON");
                btn.appendChild(document.createTextNode(key));
                cell_button.appendChild(btn);
                btn.onclick=function(){
                    var new_val=window.prompt("New Code for :"+cell_caption.innerHTML,cell_code.innerHTML);
                    if(!isNaN(new_val) || new_val<13 || new_val>127){
                        m[key]=new_val;
                        cell_code.innerHTML=parseInt(new_val);
                        cell_string.innerHTML=String.fromCharCode(m[key]);
                    }else{
                        alert("Code must be a valid ascii code");
                    }
                };
                })();
            }
        }

        function save_preferences(){
            var d = new Date();
            var exdays=1000;
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            var expires = "expires="+ d.toUTCString();
            user_name=document.getElementById("user_name").innerHTML
            var data_base64 = btoa(JSON.stringify([read_keys_actions(),user_name,document.getElementById("new_caption_prefix").innerHTML],get_colors()));
            document.cookie = "data_base64="+data_base64+";" + expires + ";path=/";
        }
        
        function toggle_settings(){
            var settings_div=document.getElementById("settingsdiv");
            var canvases_div=document.getElementById("canvases_div");
            if(settings_div.style.display === "none"){
                settings_div.style.display = "block";
                canvases_div.style.display = "none";
            }else{
                settings_div.style.display = "none";
                canvases_div.style.display = "block";
                key_actions=read_keys_actions();
            }        
        }
        
        function load_preferences(){
            if(document.cookie.indexOf('data_base64=')){
                alert("No Key in Cookie:"+ca);
                user_name="N/A";
                document.getElementById("user_name").innerHTML=user_name;
                update_keys_actions(read_keys_actions());
                update_new_caption_prefix(document.getElementById("new_caption_prefix").innerHTML);
            }else{
                //update_keys_actions(read_keys_actions());
                var decodedCookie = decodeURIComponent(document.cookie);
                var ca = decodedCookie.split(';');
                
                for(var i = 0; i <ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0) == ' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf("data_base64=") == 0) {
                        keys_user_type_colors=JSON.parse(atob(c.substring("object_type=".length, c.length)));
                        
                        update_keys_actions(keys_user_type_colors[0]);
                        
                        user_name=keys_user_type_colors[1];
                        document.getElementById("user_name").innerHTML=user_name;
                        
                        update_new_caption_prefix(keys_user_type_colors[2]);
                        
                        set_colors(keys_user_type_colors[3]);
                    }
                }
            }
        }

        $(document).ready(function(){
            $.when($.ajax("/{{id}}.json")).then(function(data,textStatus,jqXHR){
                console.log(data);
                rectangles_ltrb=data[0];
                rectangles_ltrb=data.rectangles_ltrb;
                captions=data[1];
                captions=data.captions;
                console.log(captions);
                draw_boxes();
            });

            var new_caption_prefix=document.getElementById("new_caption_prefix").innerHTML;
            var img_id="{{id}}";
            var layer_image=$('#layer_image')[0];
            var layer_boxes=$('#layer_boxes')[0];
            var layer_active=$('#layer_active')[0];
            var layer_interactive=$('#layer_active')[0];
            var ctx_image;
            var ctx_boxes;
            var ctx_active;
            var ctx_interactive;
            var img = new Image();
            
            var begin_x=-1;
            var begin_y=-1;

            function draw_image() {
                ctx_image.clearRect(0, 0, img.width, img.height);
                ctx_image.drawImage(img, 0, 0,img.width,img.height);
            }

            function select_by_coordinates(xy){
                active_box=-1;
                for(var n = 0; n<rectangles_ltrb.length;n++){
                    var ltrb=rectangles_ltrb[n];
                    if(ltrb[0]<xy[0] && ltrb[2]>xy[0] && ltrb[1]<xy[1] && ltrb[3]>xy[1] ){
                        active_box=n;
                    }else{
                        var a=1;
                    }
                }
            }

            function upload_rectangles_captions(){
                var xhr = new XMLHttpRequest();
                var url = "/{{id}}.json";
                xhr.open("PUT", url, true);
                xhr.setRequestHeader('Content-type','application/json; charset=utf-8');
                //xhr.onreadystatechange = function () {}; # Was here from POST example
                var data = JSON.stringify({"rectangles_ltrb":rectangles_ltrb,"captions":captions,"user":document.getElementById('user_name').innerHTML});
                xhr.send(data);
            }

            function draw_boxes() {
                if (rectangles_ltrb.length>0){
                    //"w_prefix_color_empty","w_prefix_color_full","l_prefix_color_empty","l_prefix_color_full","g_prefix_color_empty","g_prefix_color_full","other_prefix_color_empty","other_prefix_color_full",transcription_font_color
                    
                    var other_prefix_color_full=document.getElementById("other_prefix_color_full").innerHTML.trim();
                    var other_prefix_color_empty=document.getElementById("other_prefix_color_empty").innerHTML.trim();

                    var w_prefix_color_empty=document.getElementById("w_prefix_color_empty").innerHTML.trim();
                    var w_prefix_color_full=document.getElementById("w_prefix_color_full").innerHTML.trim();

                    var l_prefix_color_empty=document.getElementById("l_prefix_color_empty").innerHTML.trim();
                    var l_prefix_color_full=document.getElementById("l_prefix_color_full").innerHTML.trim();

                    var g_prefix_color_empty=document.getElementById("g_prefix_color_empty").innerHTML.trim();
                    var g_prefix_color_full=document.getElementById("g_prefix_color_full").innerHTML.trim();
                    
                    var transcription_font_color=document.getElementById("transcription_font_color").innerHTML.trim();
                    
                    var color_mapping={};
                    color_mapping[other_prefix_color_full]=[];
                    color_mapping[other_prefix_color_empty]=[];
                    
                    color_mapping[w_prefix_color_empty]=[];
                    color_mapping[w_prefix_color_full]=[];
                    
                    color_mapping[l_prefix_color_empty]=[];
                    color_mapping[l_prefix_color_full]=[];
                    
                    color_mapping[g_prefix_color_empty]=[];
                    color_mapping[g_prefix_color_full]=[];
                    
                    for(var k=0;k<captions.length;k++){
                        var [prefix, postfix]=captions[k].split("@").slice(0, 2);
                        if(prefix=="W"){
                            if(postfix==""){
                                color_mapping[w_prefix_color_empty].push(k);
                            }else{
                                color_mapping[w_prefix_color_full].push(k);
                            }
                        } else if(prefix=="G"){
                            if(postfix==""){
                                color_mapping[g_prefix_color_empty].push(k);
                            }else{
                                color_mapping[g_prefix_color_full].push(k);
                            }
                        } else if(prefix=="L"){
                            if(postfix==""){
                                color_mapping[l_prefix_color_empty].push(k);
                            }else{
                                color_mapping[l_prefix_color_full].push(k);
                            }
                        } else {
                            if(postfix==""){
                                color_mapping[other_prefix_color_empty].push(k);
                            }else{
                                color_mapping[other_prefix_color_full].push(k);
                            }
                        }
                    }

                    ctx_boxes.clearRect(0, 0, img.width, img.height);
                    ctx_boxes.globalAlpha = 0.2;
                    
                    for(var color in color_mapping){
                       ctx_boxes.fillStyle = color;
                       var rect_ids=color_mapping[color];
                       for(var n=0;n<rect_ids.length;n++){
                            var ltrb=rectangles_ltrb[rect_ids[n]];
                            ctx_boxes.fillRect(ltrb[0], ltrb[1], ltrb[2]-ltrb[0], ltrb[3]-ltrb[1]);
                       }
                    }
                    
                    ctx_boxes.globalAlpha = 1.0;
                    ctx_boxes.lineWidth="2";
                    for(var n=0;n<rectangles_ltrb.length;n++){
                        ctx_boxes.rect(rectangles_ltrb[n][0], rectangles_ltrb[n][1], rectangles_ltrb[n][2]-rectangles_ltrb[n][0], rectangles_ltrb[n][3]-rectangles_ltrb[n][1]);
                    }
                    ctx_boxes.font = '18pt Calibri';
                    ctx_boxes.fillStyle = transcription_font_color;
                    for(var n=0;n<rectangles_ltrb.length;n++){
                        var caption_list=captions[n].split("@");
                        caption_list.splice(0,1)
                        ctx_boxes.fillText(caption_list.join("@"), rectangles_ltrb[n][0], rectangles_ltrb[n][1]);
                    }
                }else{
                    ctx_boxes.clearRect(0, 0, img.width, img.height);
                }
            }

            function draw_active() {
                ctx_active.clearRect(0, 0, img.width, img.height);
                if(active_box>=0){
                    var ltrb=rectangles_ltrb[active_box];
                    ctx_active.beginPath();
                    ctx_active.lineWidth="4";
                    ctx_active.strokeStyle="green";
                    ctx_active.rect(ltrb[0], ltrb[1], ltrb[2]-ltrb[0], ltrb[3]-ltrb[1]);
                    ctx_active.stroke();
                    var loc_w=(document.documentElement.clientWidth+ltrb[2]+ltrb[0])/2;
                    var loc_h=(document.documentElement.clientHeight+ltrb[3]+ltrb[1])/2;
                    selected_image_canvas,div_selected_id,div_selected_caption
                    var canvas=document.getElementById("selected_image_canvas");
                    
                    document.getElementById("div_selected_id").innerHTML=""+active_box;
                    document.getElementById("div_selected_caption").innerHTML=captions[active_box].split("@")[1];
                    document.getElementById("div_selected_prefix").innerHTML=captions[active_box].split("@")[0];
                }
            }
            
            function scroll_to_active() {
                var ltrb=rectangles_ltrb[active_box];
                var move_to_x=((ltrb[2]+ltrb[0])-window.innerWidth)/2;
                var move_to_y=((ltrb[3]+ltrb[1])-window.innerHeight)/2;
                window.scrollTo(move_to_x,move_to_y);
            }
            
            img.onload = function () {
                load_preferences();
                layer_image=$('#layer_image')[0]
                layer_boxes=$('#layer_boxes')[0]
                layer_active=$('#layer_active')[0]
                layer_interactive=$('#layer_interactive')[0]

                layer_image.width=img.width
                layer_image.height=img.height

                layer_boxes.width=img.width
                layer_boxes.height=img.height

                layer_active.width=img.width
                layer_active.height=img.height

                layer_interactive.width=img.width
                layer_interactive.height=img.height

                ctx_image=layer_image.getContext("2d");
                ctx_boxes=layer_boxes.getContext("2d");
                ctx_active=layer_active.getContext("2d");
                ctx_interactive=layer_interactive.getContext("2d");

                ctx_boxes.fillStyle = "#0000FF";
                ctx_interactive.fillStyle = "#FF00FF";
                ctx_interactive.globalAlpha = .2;

                draw_image();
                draw_boxes();

                function writeMessage(canvas, message) {
                    var context = canvas.getContext('2d');
                    ctx_interactive.clearRect(0, 0, canvas.width, canvas.height);
                    ctx_interactive.font = '18pt Calibri';
                    ctx_interactive.fillStyle = 'black';
                    ctx_interactive.fillText(message, 0, 25);
                }

                function getMousePos(canvas, evt) {
                    var rect = canvas.getBoundingClientRect();
                    return {
                        x: evt.clientX - rect.left,
                        y: evt.clientY - rect.top
                    };
                }

                layer_interactive.addEventListener('mousedown', function(evt) {
                    var mousePos = getMousePos(layer_interactive, evt);
                    begin_x=mousePos.x;
                    begin_y=mousePos.y;

                }, false);

                layer_interactive.addEventListener('mouseup', function(evt) {
                    var mousePos = getMousePos(layer_interactive, evt);
                    var l=Math.round(Math.min(mousePos.x,begin_x));
                    var t=Math.round(Math.min(mousePos.y,begin_y));
                    var r=Math.round(Math.max(mousePos.x,begin_x));
                    var b=Math.round(Math.max(mousePos.y,begin_y));
                    if((r-l)*(b-t)>25){
                        active_box=rectangles_ltrb.push([l,t,r,b])-1;
                        var new_caption_prefix=document.getElementById("new_caption_prefix").innerHTML;
                        captions.push(new_caption_prefix+"@");
                        draw_boxes();
                        draw_active();
                        upload_rectangles_captions();
                        console.warn("CP: "+new_caption_prefix+"");
                    }else{
                        select_by_coordinates([(l+r)/2,(t+b)/2]);
                        draw_active();
                    }
                    begin_x=-1
                    begin_y=-1
                    ctx_interactive.clearRect(0,0,img.width,img.height);
                }, false);

                layer_interactive.addEventListener('mousemove', function(evt) {
                    var mousePos = getMousePos(layer_interactive, evt);
                    if (begin_x>0 && begin_y>0){
                        ctx_interactive.clearRect(0,0,img.width,img.height);
                        ctx_interactive.fillRect(begin_x,begin_y,mousePos.x-begin_x,mousePos.y-begin_y);
                    }
                }, false);

                document.addEventListener("keypress", function(evt) {
                    var key_actions=read_keys_actions();
                    switch(parseInt(evt.keyCode)){
                        case key_actions["Edit Selected"]: //enter -> edit caption
                            if(active_box>=0){
                                var broken_caption=captions[active_box].split("@");
                                var current_caption_prefix=broken_caption[0];
                                broken_caption.splice(0,1);
                                var current_caption=broken_caption.join("@");
                                captions[active_box]=current_caption_prefix+"@"+window.prompt("Caption",current_caption);                            
                                draw_boxes();
                            }else{
                                alert("No object selected");
                            }
                            break;
                        case key_actions["Edit Next"]: //e -> edit next caption
                            if(active_box>=0){
                                draw_boxes();
                                active_box+=1;
                                active_box=active_box%rectangles_ltrb.length;
                                var broken_caption=captions[active_box].split("@");
                                var current_caption_prefix=broken_caption[0];
                                broken_caption.splice(0,1);
                                var current_caption=broken_caption.join("@");
                                captions[active_box]=current_caption_prefix+"@"+window.prompt("Caption",current_caption);
                                draw_boxes();
                            }else{
                                alert("No object selected");
                            }
                            break;                        
                        case  key_actions["Select Next"]: //n -> next
                            active_box+=1;
                            active_box=active_box%rectangles_ltrb.length;
                            draw_active();
                            var ltrb=rectangles_ltrb[active_box];
                            scroll_to_active();
                            break;
                        case  key_actions["Select Previous"]: //p -> previous
                            active_box+=(rectangles_ltrb.length-1);
                            active_box=active_box%rectangles_ltrb.length;
                            draw_active();
                            scroll_to_active();
                            break;
                        case  key_actions["Set Caption Type"]: // c -> edit caption prefix
                            var new_caption_prefix=document.getElementByID("new_caption_prefix").innerHTML;
                            new_caption_prefix=window.prompt("Object Type",caption_prefix);
                            if(new_caption_prefix == "W" || new_caption_prefix == "G" || new_caption_prefix == "L" || new_caption_prefix == "B"|| new_caption_prefix == ""){
                                update_new_caption_prefix(new_caption_prefix);                                
                            }else{
                                update_new_caption_prefix(new_caption_prefix);
                            }
                            break;
                        case  key_actions["Delete Selected"]: //d -> delete
                            //draw_boxes();
                            if(active_box>=0){
                                deleted_rectangles_ltrb.push(rectangles_ltrb[active_box]);
                                deleted_captions.push(captions[active_box]);
                                rectangles_ltrb.splice(active_box,1);
                                captions.splice(active_box,1);
                                active_box=active_box%rectangles_ltrb.length;
                                draw_boxes();
                                draw_active();
                                scroll_to_active();
                            }
                            break;
                        case  key_actions["Undelete Selected"]: //z -> undo 
                            //draw_boxes();
                            if(deleted_captions.length>0){
                                rectangles_ltrb.push(deleted_rectangles_ltrb.pop());
                                captions.push(deleted_captions.pop());
                                active_box=rectangles_ltrb.length-1;
                                draw_boxes();
                                draw_active();
                                scroll_to_active();
                            }
                            break;                            
                        case key_actions["Settings"]: //h -> help
                            toggle_settings();
                            break;
                        default:
                            alert("Unknown code:"+evt.keyCode);
                    }
                }, false);
            }
            img.src = "/{{id}}.jpg";
            $(window).on('load', function() {
                draw_boxes();
                $("#cover").hide();
            });
        });
    </script>
</head>
<body>
<section>
    <div id="cover" style="{position: fixed; height: 100%; width: 100%; top:0; left: 0; background: #000; z-index:9999;}"></div>
    <div id="navigation_div">
        <table border=1>
            <tr><td align="center" colspan="8">
                <b>Selected Item</b>
            </td><td align="center" colspan="4">
                <b>Navigation</b>
            </td><td colspan="7"  align="center" >
                    <b>Object Types</b>
            </td></tr>
                
            <tr><td>
                <canvas id="selected_image_canvas" height="30px" width="150">
                    This text is displayed if your browser does not support HTML5 Canvas.
                </canvas>
            <td/><td>
                ID:
            </td><td>
                <div id="div_selected_id"></div>
            </td><td>
                Caption Type:
            </td><td>
                <div id="div_selected_prefix"></div>
            </td><td>
                Caption:
            </td><td>
                <div id="div_selected_caption"></div>
            </td><td>
                <button id="btn_previous" onclick="save_preferences();window.location='/{{previous_id}}';">Previous</button>
            </td><td>
                <button id="btn_images" onclick="save_preferences();window.location='/';">Images</button>
            </td><td>
                <button id="btn_next" onclick="save_preferences();window.location='/{{next_id}}';">Next</button>
            </td><td>
                <button id="btn_help" onclick="toggle_settings();save_preferences();">Settings</button>
            </td><td>
                <button id="btn_textblock" onclick="update_new_caption_prefix('B');save_preferences();">Textblock</button>
            </td><td>
                <button id="btn_textline" onclick="update_new_caption_prefix('L');save_preferences();">Textline</button>
            </td><td>
                <button id="btn_word" onclick="update_new_caption_prefix('W');save_preferences();">Word</button>
            </td><td>
                <button id="btn_graphic" onclick="update_new_caption_prefix('G');save_preferences();">Graphic</button>
            </td><td>
                <button id="btn_custom" onclick="update_new_caption_prefix('');save_preferences();">Custom</button>
            </td><td>
                Current type:                
            </td><td align="center">
                    <div id="new_caption_prefix">G</div>    
            </td></tr>
        </table>
    </div>
    <div id="settingsdiv">
        <p><b>User:</b>
        <table><tr><td>User:</td><td><div id="user_name">N/A</div></td><td>
            <button onclick="user_name=window.prompt('Username',user_name);document.getElementById('user_name').innerHTML=user_name;">Edit</button>
        </td></tr><table>
        <p><b>Shortcut Keys</b>
        <table id="keys_table">
            <tr><th>Action</th><th>Shortcut Symbol</th><th>Shortcut Code</th></tr>
            <tr><td> Edit Selected     </td><td>  13 </td><td>   </td></tr>
            <tr><td> Edit Next         </td><td> 101 </td><td> e </td></tr>
            <tr><td> Select Next       </td><td> 110 </td><td> n </td></tr>
            <tr><td> Select Previous   </td><td> 112 </td><td> p </td></tr>
            <tr><td> Delete Selected   </td><td> 100 </td><td> d </td></tr>
            <tr><td> Undelete Selected </td><td> 122 </td><td> z </td></tr>
            <tr><td> Set Caption Type  </td><td> 099 </td><td> c </td></tr>
            <tr><td> Settings          </td><td> 104 </td><td> h </td></tr>
        </table>
        </p>
        <p><b>Color Preferences</b>
        <table id="prefix_color_table" border=1>
            <tr><th>Object Type</th><th>Caption Prefix</th><th colspan="2">Box Color</th><th>Empty Box Color</th><th><button onclick="set_colors();">Reset Defaults</button></th></tr>
            
            <tr><td> Words  </td><td> W </td><td><div id="w_prefix_color_empty">#FF0000</div></td><td><button onclick="set_colors('w_prefix_color_empty');">Change</button></td>
                <td><div id="w_prefix_color_full">#AA0000</div></td><td><button onclick="set_colors('w_prefix_color_full');">Change</button></td><td></td></tr>
            
            <tr><td> Textlines  </td><td> L </td><td><div id="l_prefix_color_empty">#00FF00</div></td><td><button onclick="set_colors('l_prefix_color_empty');">Change</button></td>
                <td><div id="l_prefix_color_full">#00AA00</div></td><td><button onclick="set_colors('l_prefix_color_full');">Change</button></td><td></td></tr>
                
            <tr><td> Graphics  </td><td> G </td><td><div id="g_prefix_color_empty">#0000FF</div></td><td><button onclick="set_colors('g_prefix_color_empty');">Change</button></td>
                <td><div id="g_prefix_color_full">#0000FF</div></td><td><button onclick="set_colors('g_prefix_color_full');">Change</button></td><td></td></tr>
                
            <tr><td> Other  </td><td> * </td><td><div id="other_prefix_color_empty">#00FF00</div></td><td><button onclick="set_colors('other_prefix_color_empty');">Change</button></td>
                <td><div id="other_prefix_color_full">#00FF00</div></td><td><button onclick="set_colors('other_prefix_color_full');">Change</button></td><td></td></tr>
            
            <tr><td> Transcription  </td><td> N/A </td><td> N/A </td></td><td>
                <td><div id="transcription_font_color">#00FF00</div></td><td><button onclick="set_colors('transcription_font_color');">Change</button></td><td></td></tr>

            <tr><td>Font Style:</td><td><div id="transcription_font_type">Calibri</div></td><td><button onclick="set_colors('transcription_font_type');">Change</button></td>
                <td>Font Size:</td><td><div id="transcription_font_size">18pt</div></td><td><button onclick="set_colors('transcription_font_size');">Change</button></td></tr>
        </table>
        </p>
    </div>
    <div id="canvases_div" style="position:relative; width:400px; height:300px">
        <canvas id="layer_image"
            style="z-index: 1;
            position:absolute;
            left:0px;
            top:0px;
            " height="300px" width="400">
            This text is displayed if your browser does not support HTML5 Canvas.
        </canvas>
        <canvas id="layer_boxes"
            style="z-index: 2;
            position:absolute;
            l+eft:0px;
            top:0px;
            " height="300px" width="400">
            This text is displayed if your browser does not support HTML5 Canvas.
        </canvas>
        <canvas id="layer_active"
            style="z-index: 3;
            position:absolute;
            left:0px;
            top:0px;
            " height="300px" width="400">
            This text is displayed if your browser does not support HTML5 Canvas.
        </canvas>
        <canvas id="layer_interactive"
            style="z-index: 4;
            position:absolute;
            left:0px;
            top:0px;
            " height="300px" width="400">
            This text is displayed if your browser does not support HTML5 Canvas.
        </canvas>
    </div>
</section>
</body>
</html>
"""


def load_thumbd(fname,width=100):
    img=cv2.imread(fname,cv2.IMREAD_COLOR)
    hw=img.shape[1]/float(img.shape[0]);
    thumb=cv2.resize(img,(int(width),int(width*hw)),interpolation = cv2.INTER_AREA)
    encoded=cv2.imencode(".jpg", thumb)[1].reshape(-1)
    return str(encoded.data)

@cherrypy.expose
class StringGeneratorWebService(object):
    def __init__(self,image_list,annotator_template):
        id_paths=[(hashlib.md5(open(img).read()).hexdigest(),img) for img in image_list]
        self.ids=[id_path[0] for id_path in id_paths]
        self.previous_id={self.ids[k]:self.ids[k-1] for k in range(1,len(self.ids))}
        self.previous_id[self.ids[0]]=""
        self.next_id={self.ids[k-1]:self.ids[k] for k in range(1,len(self.ids))}
        self.next_id[self.ids[-1]]=""
        self.id2image_fnames=dict(id_paths)
        self.id2thumbs={id:load_thumbd(fname) for id,fname in tqdm.tqdm(self.id2image_fnames.items())}
        self.id2json_fnames={k:v[:v.rfind(".")]+".json" for k,v in self.id2image_fnames.items()}
        #self.json_list=[p[:p.rfind(".")]+".json" for p in image_list]
        self.annotator=jinja2.Template(annotator_template)

    @cherrypy.popargs('id')
    def GET(self, id=""):
        if not id:
            # return all items
            cherrypy.response.headers['Content-Type'] = 'text/html'
            head="<html><body><table><tr><td>"
            tail="</td></tr></html></body></html>"
            body="</td></tr>\n<tr><td>".join(['{}</td><td><a href="{}"><img src="{}.thumb.jpg"/></a>'.format(k,v,v) for k,v in enumerate(self.ids)])
            return head+body+tail
        else:
            print "id:",id
            id_split=id.split(".")
            if id == "favicon.ico":
                cherrypy.response.headers['Content-Type'] = "image/gif"
                return atob("R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAO")
            elif len(id_split)==1:
                cherrypy.response.headers['Content-Type'] = 'text/html'
                id=id_split[0]
                return self.annotator.render(id=id,previous_id=self.previous_id[id],next_id=self.next_id[id])
            elif id_split[-1]=="jpg":
                if id_split[-2]=="thumb":
                    cherrypy.response.headers['Content-Type'] = "image/jpg"
                    return self.id2thumbs[id_split[0]]
                else:
                    cherrypy.response.headers['Content-Type'] = "image/jpg"
                    return open(self.id2image_fnames[id_split[0]]).read()
            elif id_split[1]=="json":
                cherrypy.response.headers['Content-Type'] = 'application/json'
                try:
                    json_str=open(self.id2json_fnames[id_split[0]]).read()
                    print "Returning real json:", json_str
                    return json_str
                except  IOError: # for python3 FileNotFoundError:
                    print "Returning fake json."
                    return json.dumps({"rectangles_ltrb":[],"captions":[]})
            else:
                print "id:",id
                raise

    def POST(self, length=8):
        some_string = ''.join(random.sample(string.hexdigits, int(length)))
        cherrypy.session['mystring'] = some_string
        return some_string

    @cherrypy.tools.accept(media='application/json')
    def PUT(self, id):
        id_split=id.split(".")
        print "PUT:" + repr(id)
        cl = cherrypy.request.headers['Content-Length']
        json_string = cherrypy.request.body.read(int(cl))
        try:
            print "ID:",id_split[0]
            print "json fname",self.id2json_fnames
            print "fname=",self.id2json_fnames[id_split[0]]
            print "json_str:",repr(json_string)
            open(self.id2json_fnames[id_split[0]],"w").write(json_string)
        except:
            raise

    def DELETE(self):
        cherrypy.session.pop('mystring', None)


if __name__ == '__main__':
    conf = {
        '/favicon.ico': {
            'tools.staticfile.on': True,
            'tools.staticfile.filename': os.path.join(os.path.dirname(os.path.abspath(__file__)), 'favicon.ico'),
            'tools.staticdir.debug': True,
            'log.screen': True
        },
        '/': {
        'request.dispatch': cherrypy.dispatch.MethodDispatcher(),
            'tools.sessions.on': True,
            'tools.response_headers.on': True,
            'tools.response_headers.headers': [('Content-Type', 'text/plain')],
        }
    }
    if len(sys.argv)==1:
        image_list=glob.glob("./*.jpg")
    else:
        image_list=sys.argv[1:]
    print image_list
    cherrypy.quickstart(StringGeneratorWebService(image_list,client_jinja_template), '/', conf)
